# Story 2.1: TEXT Node Traversal and Content Extraction

## Status: Ready

## Story
**As a** Plugin System  
**I want to** traverse TEXT nodes by scope and extract content with proper references  
**So that** I can analyze text content while maintaining traceability to source nodes

## Epic
Epic 2: Scan & Issue Surfacing (MVP)

## Acceptance Criteria
1. **AC1.1**: System can traverse TEXT nodes in selection, current page, or entire file
   - Selection scope: only traverse selected nodes and their children
   - Page scope: traverse all TEXT nodes on current page
   - File scope: traverse all TEXT nodes across all pages

2. **AC1.2**: Text content is extracted with node ID and page references preserved
   - Each text extraction includes Figma node ID
   - Page name and ID are captured for multi-page files
   - Character ranges are tracked for precise issue location

3. **AC1.3**: Nested text formatting and styles are handled correctly
   - Rich text with multiple styles is processed accurately
   - Text segments with different formatting are preserved
   - Special characters and Unicode content handled properly

4. **AC1.4**: Empty or whitespace-only nodes are appropriately filtered
   - Skip nodes with only whitespace or empty content
   - Preserve intentional spacing in mixed content
   - Handle invisible characters appropriately

5. **AC1.5**: Performance remains acceptable for files with many TEXT nodes (≤5k nodes < 2s)
   - Streaming traversal that yields to main thread
   - Progress indication for long-running scans
   - Memory-efficient processing of large node sets

## Priority
High - Foundation for scanning functionality

## Effort Estimate
8 story points

## Dependencies
- Story 1.4: Settings (for scope configuration)
- Figma Plugin API for node access

## Tasks / Subtasks
- [ ] **Task 1**: Design traversal architecture
  - [ ] Plan node traversal algorithms for each scope
  - [ ] Design data structures for extracted content
  - [ ] Define interfaces for text extraction

- [ ] **Task 2**: Implement scope-based traversal
  - [ ] Selection scope traversal logic
  - [ ] Page scope traversal implementation
  - [ ] File scope with multi-page handling

- [ ] **Task 3**: Build text extraction system
  - [ ] Extract plain text with character positions
  - [ ] Handle rich text and formatting preservation
  - [ ] Capture node and page metadata

- [ ] **Task 4**: Add filtering and validation
  - [ ] Filter empty and whitespace-only nodes
  - [ ] Validate node types and accessibility
  - [ ] Handle edge cases and malformed nodes

- [ ] **Task 5**: Implement performance optimizations
  - [ ] Streaming traversal with yielding
  - [ ] Progress tracking and user feedback
  - [ ] Memory usage optimization

- [ ] **Task 6**: Add comprehensive testing
  - [ ] Unit tests for each traversal scope
  - [ ] Performance testing with large files
  - [ ] Edge case testing (empty nodes, special characters)

## Definition of Done
- [ ] All three scopes (selection/page/file) work correctly
- [ ] Text extraction preserves node/page references
- [ ] Rich text formatting is handled properly
- [ ] Empty/whitespace nodes are filtered appropriately
- [ ] Performance targets met (≤5k nodes in <2s)
- [ ] Progress indication works for long operations
- [ ] Memory usage is efficient and predictable
- [ ] Comprehensive test coverage

## Technical Requirements
- Asynchronous traversal to prevent UI blocking
- Efficient data structures for large node sets
- Proper error handling for inaccessible nodes
- Unicode and international text support

## Data Structure for Extracted Content
```typescript
interface ExtractedText {
  nodeId: string;
  pageId: string;
  pageName: string;
  content: string;
  characterRange: {
    start: number;
    end: number;
  };
  formatting?: TextFormatting[];
  metadata: {
    nodeType: string;
    visible: boolean;
    locked: boolean;
  };
}
```

## Performance Considerations
- Batch node access to reduce API calls
- Use generators for memory-efficient processing
- Implement cancellation for long-running operations
- Cache node references for repeated access
