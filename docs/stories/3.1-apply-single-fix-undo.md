# Story 3.1: Apply Single Fix with Undo Support

## Status: Ready

## Story
**As a** Designer or UX Writer  
**I want to** apply individual fixes to flagged text with full undo support  
**So that** I can carefully review and implement changes with confidence

## Epic
Epic 3: Fix Application & Undo (MVP)

## Acceptance Criteria
1. **AC1.1**: User can apply a single fix to a specific flagged text range
   - "Apply Fix" button available for each issue
   - Fix replaces original text with suggested alternative
   - Operation completes quickly with visual feedback

2. **AC1.2**: Fix updates the actual node.characters in Figma
   - Direct integration with Figma's text manipulation API
   - Preserves text formatting and styles around the change
   - Handles Unicode and special characters correctly

3. **AC1.3**: All fixes are fully compatible with Figma's native undo system
   - Applied fixes appear in Figma's undo history
   - Ctrl+Z/Cmd+Z undoes the fix operation
   - Redo functionality works correctly

4. **AC1.4**: Visual feedback confirms successful fix application
   - Success message or animation after fix
   - Issue disappears from issues list immediately
   - Highlight removed from canvas

5. **AC1.5**: Fixed issues are marked as resolved in the issues panel
   - Issue status changes to "Fixed"
   - Timestamp recorded for fix application
   - Fixed issues can be filtered/hidden

## Priority
High - Core functionality

## Effort Estimate
6 story points

## Dependencies
- Story 2.2: Issues panel (for issue data and UI)
- Story 2.3: Canvas highlights (for visual updates)
- Figma Plugin API for text manipulation

## Tasks / Subtasks
- [ ] **Task 1**: Design fix application architecture
  - [ ] Plan integration with Figma's text API
  - [ ] Design undo system integration
  - [ ] Define fix operation data structures

- [ ] **Task 2**: Implement text replacement system
  - [ ] Build precise character range replacement
  - [ ] Preserve formatting and styles
  - [ ] Handle edge cases (empty text, special characters)

- [ ] **Task 3**: Integrate with Figma's undo system
  - [ ] Ensure fixes create proper undo entries
  - [ ] Test undo/redo functionality thoroughly
  - [ ] Handle undo system edge cases

- [ ] **Task 4**: Create fix application UI
  - [ ] Add "Apply Fix" buttons to issue items
  - [ ] Implement loading states during fix
  - [ ] Add success/error feedback

- [ ] **Task 5**: Implement issue status management
  - [ ] Update issue status to "Fixed"
  - [ ] Record fix timestamps
  - [ ] Sync status across UI components

- [ ] **Task 6**: Add visual feedback system
  - [ ] Success animations or messages
  - [ ] Remove highlights from canvas
  - [ ] Update issues panel display

- [ ] **Task 7**: Error handling and edge cases
  - [ ] Handle locked or inaccessible nodes
  - [ ] Manage concurrent fix operations
  - [ ] Provide clear error messages

- [ ] **Task 8**: Testing and validation
  - [ ] Unit tests for fix application logic
  - [ ] Integration tests with Figma API
  - [ ] Undo/redo system testing

## Definition of Done
- [ ] Single fixes can be applied to individual issues
- [ ] Text replacement works correctly in Figma nodes
- [ ] Undo/redo integration functions properly
- [ ] Visual feedback confirms successful operations
- [ ] Issue status updates correctly to "Fixed"
- [ ] Error handling covers edge cases
- [ ] Performance is acceptable for rapid fix application
- [ ] Comprehensive testing completed

## Technical Requirements
- Direct integration with figma.currentPage.selection
- Precise character range manipulation
- Atomic operations for consistency
- Proper error handling and rollback

## Error Scenarios to Handle
- Node is locked or read-only
- Text node is deleted during operation
- Invalid character ranges
- Network interruption during operation
- Concurrent modifications to the same node

## Success Metrics
- Fix application success rate > 99%
- Fix operation completion time < 500ms
- Zero data corruption incidents
- User satisfaction with undo reliability
